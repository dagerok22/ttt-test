!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=4)}([function(e,t,n){"use strict";n.d(t,"a",function(){return i});var r=n(8);const i=n.n(r).a.createLogger({name:"ttt-game-test"})},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("lodash")},function(e,t,n){"use strict";n.r(t),n.d(t,"io",function(){return u}),n.d(t,"http",function(){return a});var r=n(12),i=n.n(r),s=n(11),o=n(0);const a=n(14).Server(s.a),u=i()(a);a.listen(process.env.PORT||3e3,()=>{o.a.warn(`Listening on port ${process.env.port||3e3}`)})},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var r=n(2),i=n.n(r),s=n(1),o=n.n(s),a=n(4),u=n(3),c=n.n(u),l=n(0);const h=new o.a.Schema({row:Number,column:Number,player:String}),f=new o.a.Schema({winner:{type:String,required:!0},moves:{type:[h],default:[]}},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});f.virtual("formattedWinner").get(function(){return 1===this.winner?"You won":2===this.winner?"You lost":"Draw"});const d=new o.a.Schema({user:{type:String},games:{type:[f],required:!0,default:[]},date:{type:Number,required:!0,default:Date.now(),get:e=>new Date(e).toLocaleDateString(),set:e=>e.getTime()}});var m=o.a.model("Statistic",d);function _(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function r(i,s){try{var o=t[i](s),a=o.value}catch(e){return void n(e)}if(!o.done)return Promise.resolve(a).then(function(e){r("next",e)},function(e){r("throw",e)});e(a)}("next")})}}const p=i.a.Router();var A;p.get("/",(e,t)=>(a.io.on("connection",e=>{l.a.info("Connected");const t=new class{constructor(e){this._field=[[0,1,2],[3,4,5],[6,7,8]],this._indexOfPlayerToTurn=e,this._turns=[],this._winner=0,this._games=[],this.AI_PLAYER="O",this.HUMAN_PLAYER="X"}getTurns(){return this._turns}getState(){return{field:this._field,winner:this._winner}}getStats(){const e=this._games.map(e=>({winner:e.winner,moves:e.turns}));return l.a.info(this),this._winner&&e.push({winner:this._winner,moves:this._turns}),e}retry(e){return this._winner&&this._games.push({turns:this._turns,winner:this._winner}),this._field=[[0,1,2],[3,4,5],[6,7,8]],this._indexOfPlayerToTurn=e,this._turns=[],this._winner=0,this.getState()}playerTurn({row:e,column:t},n){if(l.a.info("start",this._indexOfPlayerToTurn,n,this._field[+e][+t]),!e||!t||this._indexOfPlayerToTurn!==n||!Number.isInteger(this._field[+e][+t]))return;this._field[e][t]=n,this._turns.push({row:e,column:t,player:n}),this._indexOfPlayerToTurn=n===this.HUMAN_PLAYER?this.AI_PLAYER:this.HUMAN_PLAYER;let r=this.isOver();return 0===r&&(this.makeTurnForPlayer(n===this.HUMAN_PLAYER?this.AI_PLAYER:this.HUMAN_PLAYER),r=this.isOver()),this._winner=r,this.getState()}makeTurnForPlayer(e){if(this._indexOfPlayerToTurn!==e)return;l.a.info(c.a.flatten(this._field));const t=c.a.flatten(this._field).filter(e=>e!==this.HUMAN_PLAYER&&e!==this.AI_PLAYER);let n;l.a.info(t),n=t.length<8?this.getBestMove(e):t[Math.floor(Math.random()*t.length)];const r=Math.floor(n/3),i=n%3;l.a.info(r,i),l.a.warn(this._field[r][i]),this._field[r][i]=e,this._turns.push({row:r,column:i,player:e}),this._indexOfPlayerToTurn=e===this.AI_PLAYER?this.HUMAN_PLAYER:this.AI_PLAYER}isOver(){return this.isWinning(this.HUMAN_PLAYER)?(l.a.info("Human won",c.a.flatten(this._field)),this.HUMAN_PLAYER):this.isWinning(this.AI_PLAYER)?(l.a.info("AI won",c.a.flatten(this._field)),this.AI_PLAYER):c.a.flatten(this._field).reduce((e,t)=>Number.isInteger(t)?e+1:e,0)?0:-1}getBestMove(e){const t=c.a.flatten(this._field),n=this.minimax(t,e);return l.a.info("best move",n),n.index}minimax(e,t){const n=this.emptyIndexies(e);if(l.a.info("newField",e),l.a.info("availSpots",n),this.isWinning(this.HUMAN_PLAYER,e))return{score:-10};if(this.isWinning(this.AI_PLAYER,e))return{score:10};if(0===n.length)return{score:0};const r=[];for(let i=0;i<n.length;i++){const s={};if(s.index=e[n[i]],e[n[i]]=t,t==this.AI_PLAYER){let t=this.minimax(e,this.HUMAN_PLAYER);s.score=t.score}else{let t=this.minimax(e,this.AI_PLAYER);s.score=t.score}e[n[i]]=s.index,l.a.info("move",s),r.push(s)}let i;if(t===this.AI_PLAYER){let e=-1e4;for(let t=0;t<r.length;t++)r[t].score>e&&(e=r[t].score,i=t)}else{let e=1e4;for(let t=0;t<r.length;t++)r[t].score<e&&(e=r[t].score,i=t)}return r[i]}emptyIndexies(e){return e.filter(e=>e!==this.HUMAN_PLAYER&&e!==this.AI_PLAYER)}isWinning(e,t=c.a.flatten(this._field)){return t[0]===e&&t[1]===e&&t[2]===e||t[3]===e&&t[4]===e&&t[5]===e||t[6]===e&&t[7]===e&&t[8]===e||t[0]===e&&t[3]===e&&t[6]===e||t[1]===e&&t[4]===e&&t[7]===e||t[2]===e&&t[5]===e&&t[8]===e||t[0]===e&&t[4]===e&&t[8]===e||t[2]===e&&t[4]===e&&t[6]===e}}("X");e.emit("connection-status","connected"),e.emit("update-field",t.getState()),e.on("save-stats",_(function*(){const n=new m;n.user=e.handshake.address,n.games=t.getStats(),yield n.save(),l.a.info("stats saved",n),e.emit("stats-saved",n._id)})),e.on("player-turn",n=>{l.a.info("Player ",t.HUMAN_PLAYER);let r=t.playerTurn(n,t.HUMAN_PLAYER);l.a.info("results",r),e.emit("update-field",r)}),e.on("retry",()=>{let n=t.retry(t.HUMAN_PLAYER);e.emit("update-field-retry",n)}),e.on("disconnect",()=>{l.a.info("Disconnected"),e.emit("connection-status","Disconnected")})}),t.render("game"))),p.get("/statistics/:statsId",(A=_(function*(e,t,n){if(!o.a.Types.ObjectId.isValid(e.params.statsId))return t.json({error:1,message:"Invalid ID"});const r=yield m.findById(e.params.statsId);return r?t.render("stats",r.toJSON()):(t.status=404,n())}),function(e,t,n){return A.apply(this,arguments)}));var g=p;const P=i.a.Router();P.get("/",(e,t)=>t.render("index")),P.use("/game",g);t.a=P},function(e,t){e.exports=require("bunyan")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("morgan")},function(e,t,n){"use strict";(function(e){var r=n(2),i=n.n(r),s=n(6),o=n.n(s),a=n(10),u=n.n(a),c=n(9),l=n.n(c),h=n(5),f=n.n(h),d=(n(13),n(7));const m=i()();m.set("views",o.a.join(e,"views")),m.set("view engine","hbs"),m.use(u()("dev")),m.use(f.a.json()),m.use(f.a.urlencoded({extended:!1})),m.use(l()()),m.use(i.a.static(o.a.join(e,"public"))),m.use("/",d.a),m.use(function(e,t,n){const r=new Error("Not Found");r.status=404,n(r)}),m.use(function(e,t,n){n.locals.message=e.message,n.locals.error="development"===t.app.get("env")?e:{},n.status(e.status||500),n.render("error")}),t.a=m}).call(this,"src")},function(e,t){e.exports=require("socket.io")},function(e,t,n){"use strict";var r=n(1),i=n.n(r),s={connectionAddress:"mongodb://cnxo138mx18:mIaudm9asud9SAUdamusd@test-shard-00-00-b4nqr.mongodb.net:27017,test-shard-00-01-b4nqr.mongodb.net:27017,test-shard-00-02-b4nqr.mongodb.net:27017/test?ssl=true&replicaSet=Test-shard-0&authSource=admin"};i.a.Promise=global.Promise;try{i.a.connect(s.connectionAddress)}catch(e){console.log(e)}},function(e,t){e.exports=require("http")}]);
//# sourceMappingURL=backend.js.map