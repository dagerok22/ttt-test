!function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=3)}([function(e,t,n){"use strict";n.d(t,"a",function(){return s});var r=n(8);const s=n.n(r).a.createLogger({name:"ttt-game-test"})},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";n.r(t),n.d(t,"io",function(){return a}),n.d(t,"http",function(){return u});var r=n(12),s=n.n(r),i=n(11),o=n(0);const u=n(14).Server(i.a),a=s()(u);u.listen(process.env.PORT||3e3,()=>{o.a.warn(`Listening on port ${process.env.port||3e3}`)})},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var r=n(2),s=n.n(r),i=n(1),o=n.n(i),u=n(3),a=n(4),c=n.n(a),d=n(0);const l=new o.a.Schema({row:Number,column:Number,player:Number}),f=new o.a.Schema({winner:{type:Number,required:!0},moves:{type:[l],default:[]}},{toJSON:{virtuals:!0},toObject:{virtuals:!0}});f.virtual("formattedWinner").get(function(){return 1===this.winner?"You won":2===this.winner?"You lost":"Draw"});const h=new o.a.Schema({user:{type:String},games:{type:[f],required:!0,default:[]},date:{type:Number,required:!0,default:Date.now(),get:e=>new Date(e).toLocaleDateString(),set:e=>e.getTime()}});var p=o.a.model("Statistic",h);function m(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function r(s,i){try{var o=t[s](i),u=o.value}catch(e){return void n(e)}if(!o.done)return Promise.resolve(u).then(function(e){r("next",e)},function(e){r("throw",e)});e(u)}("next")})}}const g=s.a.Router();var v;g.get("/",(e,t)=>(u.io.on("connection",e=>{d.a.info("Connected");const t=new class{constructor(e){this._field=[[0,0,0],[0,0,0],[0,0,0]],this._indexOfPlayerToTurn=e,this._turns=[],this._winner=0,this._games=[]}getTurns(){return this._turns}getState(){return{field:this._field,winner:this._winner}}getStats(){const e=this._games.map(e=>({winner:e.winner,moves:e.turns}));return d.a.info(this),this._winner&&e.push({winner:this._winner,moves:this._turns}),e}retry(e){return this._winner&&this._games.push({turns:this._turns,winner:this._winner}),this._field=[[0,0,0],[0,0,0],[0,0,0]],this._indexOfPlayerToTurn=e,this._turns=[],this._winner=0,this.getState()}playerTurn({row:e,column:t},n){if(!e||!t||this._indexOfPlayerToTurn!==n||0!==this._field[+e][+t])return;this._field[e][t]=n,this._turns.push({row:e,column:t,player:n}),this._indexOfPlayerToTurn=1===n?2:1;let r=this.isOver();return 0===r&&(this.makeTurnForPlayer(1===n?2:1),r=this.isOver()),this._winner=r,this.getState()}makeTurnForPlayer(e){if(this._indexOfPlayerToTurn!==e)return;let t=this._field.map((e,t)=>e.map((e,t)=>{if(0===e)return t}).map(e=>[t,e]).filter(e=>void 0!==e[0]&&void 0!==e[1])).reduce((e,t)=>e.concat(t),[]);console.log(t);let n=t[Math.round(Math.random()*(t.length-1))];this._field[n[0]][n[1]]=e,this._turns.push({row:n[0],column:n[1],player:e}),this._indexOfPlayerToTurn=2===e?1:2}isOver(){return this.isWinning(1)?1:this.isWinning(2)?2:c.a.flatten(this._field).reduce((e,t)=>0===t?e+1:e,0)?0:-1}isWinning(e){const t=c.a.flatten(this._field);return t[0]===e&&t[1]===e&&t[2]===e||t[3]===e&&t[4]===e&&t[5]===e||t[6]===e&&t[7]===e&&t[8]===e||t[0]===e&&t[3]===e&&t[6]===e||t[1]===e&&t[4]===e&&t[7]===e||t[2]===e&&t[5]===e&&t[8]===e||t[0]===e&&t[4]===e&&t[8]===e||t[2]===e&&t[4]===e&&t[6]===e}}(1);e.emit("connection-status","connected"),e.emit("update-field",t.getState()),e.on("save-stats",m(function*(){const n=new p;n.user=e.handshake.address,n.games=t.getStats(),yield n.save(),d.a.info("stats saved",n),e.emit("stats-saved",n._id)})),e.on("player-turn",n=>{let r=t.playerTurn(n,1);e.emit("update-field",r)}),e.on("retry",()=>{let n=t.retry(1);e.emit("update-field-retry",n)}),e.on("disconnect",()=>{d.a.info("Disconnected"),e.emit("connection-status","Disconnected")})}),t.render("game"))),g.get("/statistics/:statsId",(v=m(function*(e,t,n){if(!o.a.Types.ObjectId.isValid(e.params.statsId))return t.json({error:1,message:"Invalid ID"});const r=yield p.findById(e.params.statsId);return r?t.render("stats",r.toJSON()):(t.status=404,n())}),function(e,t,n){return v.apply(this,arguments)}));var w=g;const _=s.a.Router();_.get("/",(e,t)=>t.render("index")),_.use("/game",w);t.a=_},function(e,t){e.exports=require("bunyan")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("morgan")},function(e,t,n){"use strict";(function(e){var r=n(2),s=n.n(r),i=n(6),o=n.n(i),u=n(10),a=n.n(u),c=n(9),d=n.n(c),l=n(5),f=n.n(l),h=(n(13),n(7));const p=s()();p.set("views",o.a.join(e,"views")),p.set("view engine","hbs"),p.use(a()("dev")),p.use(f.a.json()),p.use(f.a.urlencoded({extended:!1})),p.use(d()()),p.use(s.a.static(o.a.join(e,"public"))),p.use("/",h.a),p.use(function(e,t,n){const r=new Error("Not Found");r.status=404,n(r)}),p.use(function(e,t,n){n.locals.message=e.message,n.locals.error="development"===t.app.get("env")?e:{},n.status(e.status||500),n.render("error")}),t.a=p}).call(this,"src")},function(e,t){e.exports=require("socket.io")},function(e,t,n){"use strict";var r=n(1),s=n.n(r),i={connectionAddress:"mongodb://cnxo138mx18:mIaudm9asud9SAUdamusd@test-shard-00-00-b4nqr.mongodb.net:27017,test-shard-00-01-b4nqr.mongodb.net:27017,test-shard-00-02-b4nqr.mongodb.net:27017/test?ssl=true&replicaSet=Test-shard-0&authSource=admin"};s.a.Promise=global.Promise;try{s.a.connect(i.connectionAddress)}catch(e){console.log(e)}},function(e,t){e.exports=require("http")}]);
//# sourceMappingURL=backend.js.map